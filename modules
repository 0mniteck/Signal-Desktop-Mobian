
# ## HUMAN-CODE - NO AI GENERATED CODE - AGENTS HANDSOFF

if [ "$INC" != "" ]; then
  ver_num=$(echo "$last_ver_num + $INC" | bc -l)
  sed -i s/$(echo $last_ver_num)/$(echo $ver_num)/g docs/_layouts/default.html
  sed -i s/$(echo $last_ver_num)/$(echo $ver_num)/g docs/README.md
  sed -i s/$(echo $last_ver_num)/$(echo $ver_num)/g readme.md
  sed -i s/$(echo $last_ver_num)/$(echo $ver_num)/g Dockerfile
  sed -i s/last_ver_num=$last_ver_num/last_ver_num=$ver_num/g .pinned_ver
  echo "Version Incremented From v$last_ver_num To v$ver_num"
fi

pushd Results > /dev/null
  rm -f $MODULE.* readme.md && echo && echo 'Starting cosign...'
  cosign_run_b="script -q -c 'cosign verify-attestation $source_loc \
    --certificate-oidc-issuer https://github.com/login/oauth --certificate-identity $SIGSTORE_USR \
    --type spdxjson > base.image.sig' /dev/null > base.image.attested"
  quiet $cosign_run_b || quiet $cosign_run_b || exit 1
  cat base.image.attested && echo
popd > /dev/null

docker buildx create \
  --name $MODULE-builder --buildkitd-flags "--oci-worker-rootless=true" \
  --driver docker-container --driver-opt "network=host,default-load=true" --bootstrap --use

if [[ "$last_rel_date" != "$rel_date" ]]; then
  sed -i 's/last_rel_date=$last_rel_date/last_rel_date=$rel_date/' .pinned_ver
  docker buildx build $CROSS \
    --push --tag $REPO/$MODULE:$rel_date \
    --metadata-file Results/$MODULE.meta.json \
    --attest "type=provenance,mode=max" \
    --label org.opencontainers.image.vendor=$REPO \
    --label org.opencontainers.image.licenses=GPL-3.0 \
    --build-arg SOURCE_DATE_EPOCH=$source_date_epoch \
    --build-arg SOURCE=$source \
    --build-arg NODE_VERSION=$node_ver \
    --build-arg NVM_VERSION=$nvm_ver \
    --build-arg PNPM_VERSION=$pnpm_ver .
  docker buildx stop $MODULE-builder && wait
  docker buildx rm -f --all-inactive && wait
  docker buildx prune -f -a && wait && echo
fi

pushd Results > /dev/null
  scan_using_grype $MODULE $REPO/$MODULE:$rel_date $rel_date
  echo '# '$REPO/$MODULE:$rel_date > $MODULE.image.digest
  cat $MODULE.meta.json | jq .[] | tail -n 2 | grep sha256 | sed 's/\"//g' >> $MODULE.image.digest
  cat $MODULE.image.digest >> readme.md && cat readme.md && echo && echo 'Starting cosign...'
  cosign_run="script -q -c 'cosign verify-attestation docker.io/$REPO/$MODULE:$rel_date \
    --certificate-oidc-issuer https://github.com/login/oauth --certificate-identity $SIGSTORE_USR \
    --type spdxjson > $MODULE.image.sig' /dev/null > $MODULE.image.attested"
  quiet $cosign_run || quiet $cosign_run || exit 1
  cat $MODULE.image.attested && echo
popd > /dev/null

docker run -it --cpus=$(nproc) \
  --network=name=host,\"driver-opt=network=host\" \
  --name $MODULE --platform linux/arm64 \
  -e PNPM_HOME=/tmp/.pnpm-home \
  -e NPM_CONFIG_CACHE=/tmp/.npm-cache \
  -e SOURCE_DATE_EPOCH=$source_date_epoch \
   $REPO/$MODULE:$rel_date $TEST $SIGNING_KEY

rm -r -f builds/release && mkdir -p builds/release
docker cp $MODULE:/$NAME/release/ builds/ && rm -r -f builds/release/linux-*
mv builds/release/*.sha*sum Results/

pushd Results/ > /dev/null
  if [ "$check_file" = "1" ]; then
    cp /tmp/release.last.sha512sum release.last.sha512sum
    sha512sum -c release.last.sha512sum && REP="ly Reproduced" && \
    rm -f /tmp/release.last.sha512sum && rm -f release.last.sha512sum || exit 1
  fi
  echo "Successful$REP Build"
popd > /dev/null

echo "# Base Build System: $(uname -o) $(uname -m) $(uname -p) $(lsb_release -ds) $(lsb_release -cs) $(uname -v)"  >> Results/release.sha512sum
awk '{a[i++]=$0}END{for(j=0;j<i-2;j++)print a[j];print a[i-1];print a[i-2]}' Results/release.sha512sum > tmp && mv tmp Results/release.sha512sum
ls -la builds/release/ && ls -la Results
